<ui:composition template="/templates/layout.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://xmlns.jcp.org/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	xmlns:f="http://xmlns.jcp.org/jsf/core"
	xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

	<ui:define name="content">
		<h:form id="inboxForm">
			<h2>
				<i class="pi pi-envelope"></i> Nachrichten
			</h2>

			<!-- ðŸ“ Ordner-Auswahl -->
			<p:selectOneMenu value="#{igmOrdnerBean.ausgewaehlterOrdner}"
				converter="omnifaces.SelectItemsConverter" style="width: 250px;">
				<f:selectItems value="#{igmOrdnerBean.ordnerListe}" var="ordner"
					itemLabel="#{ordner.name}" itemValue="#{ordner}" />
				<p:ajax listener="#{igmOrdnerBean.ordnerWechseln}"
					update="inboxTable" />
			</p:selectOneMenu>

			<br />
			<br />

			<!-- ðŸ§° Toolbar -->
			<p:toolbar styleClass="inbox-toolbar">
				<p:toolbarGroup>
					<p:commandButton value="Als gelesen" icon="pi pi-eye"
						actionListener="#{igmBean.markiereGelesen(true)}"
						update="inboxTable" />
					<p:commandButton value="Als ungelesen" icon="pi pi-eye-slash"
						actionListener="#{igmBean.markiereGelesen(false)}"
						update="inboxTable" />
					<p:commandButton value="LÃ¶schen" icon="pi pi-trash"
						actionListener="#{igmBean.loescheNachrichten}" update="inboxTable" />
					<p:commandButton value="AutolÃ¶schung deaktivieren"
						icon="pi pi-lock"
						actionListener="#{igmBean.setAutoloeschen(false)}"
						update="inboxTable" />
					<p:commandButton value="AutolÃ¶schung aktivieren"
						icon="pi pi-unlock"
						actionListener="#{igmBean.setAutoloeschen(true)}"
						update="inboxTable" />
					<p:commandButton value="Verschieben" icon="pi pi-folder"
						process="@this">
						<p:menu>
							<p:menuitem value="#{ordner.name}"
								actionListener="#{igmBean.verschiebeNachrichten(ordner)}"
								update="inboxTable"
								rendered="#{ordner.id ne igmOrdnerBean.ausgewaehlterOrdner.id}"
								forEach="#{igmOrdnerBean.ordnerListe}" />
						</p:menu>
					</p:commandButton>
				</p:toolbarGroup>
			</p:toolbar>

			<!-- ðŸ“œ Nachrichtentabelle -->

			<p:dataTable id="inboxTable" value="#{igmBean.nachrichten}" var="msg"
				rowKey="#{msg.id}" paginator="true" rows="10" stateful="true"
				selection="#{igmBean.markierteNachrichten}" selectionMode="multiple"
				selectionPageOnly="false" selectionRowMode="none"
				responsiveLayout="scroll" expandMode="single" widgetVar="inboxTable">

				<!-- <p:ajax event="rowSelect" update="@form" />
				<p:ajax event="rowUnselect" update="@form" />-->

				<p:column selectionBox="true" style="width:16px;text-align:center" />

				<p:column style="width:2rem" ariaHeaderText="Row Toggler">
					<p:rowToggler />
				</p:column>

				<p:column headerText="Absender">
					<h:outputText value="#{msg.cachesendername}" />
						
				</p:column>
				<!-- ðŸ’¬ Betreff anklickbar -->
				<p:column headerText="Betreff">
					<h:outputText value="#{msg.betreff}"
						style="#{msg.ungelesen ? 'font-weight:bold;' : 'font-weight:normal;'}" />
				</p:column>
				<p:column headerText="Datum">
					<h:outputText value="#{msg.datum}">
						<f:convertDateTime pattern="dd.MM.yyyy HH:mm" />
					</h:outputText>
				</p:column>
				<!-- ðŸ”½ Nachrichtendetails (erscheinen direkt unter der Zeile) -->
				<p:rowExpansion styleClass="inbox-msg-expand">
					<p:panel header="#{msg.betreff}" toggleable="false"
						style="margin:0; border:none;">
						<h:panelGrid columns="1" cellpadding="5">
							<h:outputText value="Von: #{msg.cachesendername}"
								style="color:#f5d98f;" />
							<h:outputText value="#{igmBean.resolveIgmText(msg)}" escape="false"
								style="white-space: pre-wrap; color:#ddd;" />
						</h:panelGrid>

						<!-- ðŸ§° Einzel-Toolbar -->
						<p:toolbar style="margin-top:10px">
							<p:commandButton value="LÃ¶schen" icon="pi pi-trash"
								actionListener="#{igmBean.loescheEinzeln(msg)}"
								update="inboxTable" process="@this" />
							<p:commandButton value="SchÃ¼tzen" icon="pi pi-lock"
								actionListener="#{igmBean.setEinzelnGesichert(msg, true)}"
								update="inboxTable" process="@this" />
							<p:commandButton value="AutolÃ¶schung aktivieren"
								icon="pi pi-unlock"
								actionListener="#{igmBean.setEinzelnGesichert(msg, false)}"
								update="inboxTable" process="@this" />
						</p:toolbar>
					</p:panel>
				</p:rowExpansion>
			</p:dataTable>
		</h:form>

		<script>
			function rowExpansion(dataTableWidgetVar) {
				// dataTable should be the widgetVar object
				var $this = PF(dataTableWidgetVar);

				// turn off row toggler events
				var togglerSelector = '> tr > td > div.ui-row-toggler';
				$this.tbody.off('keydown.datatable-expansion', togglerSelector);

				// add the 'hand' when hovering on row
				$this.tbody.children('tr').css('cursor', 'pointer');

				// now set the toggle to be the whole row
				togglerSelector = '> tr';

				$this.tbody.off('click.datatable-expansion', togglerSelector);
				$this.tbody.on('click.datatable-expansion', togglerSelector,
						null, function(e) {
							var target = $(e.target);
							if (target.length) {
								target = target[0];
								if (target.localName == "span"
										|| target.localName == "button"
										|| target.className
												.startsWith("ui-row-toggler")) {
									return;
								}
							}

							var row = $(this);
							// exit if this is the no data found row
							if (row.hasClass("ui-datatable-empty-message")) {
								return;
							}
							// if expanded don't close it
							if (row.hasClass("ui-expanded-row-content")) {
								return;
							}
							$this.toggleExpansion(row
									.find('div.ui-row-toggler'));
						});

				$this.tbody
						.on(
								'keydown.datatable-expansion',
								togglerSelector,
								null,
								function(e) {
									var key = e.which, keyCode = $.ui.keyCode;

									if ((key === keyCode.ENTER || key === keyCode.NUMPAD_ENTER)) {
										var row = $(this);
										// exit if this is the no data found row
										if (row
												.hasClass("ui-datatable-empty-message")) {
											return;
										}
										// toggle the current row
										if (row
												.hasClass("ui-expanded-row-content")) {
											row = row.prev();
										}
										$this.toggleExpansion(row
												.find('div.ui-row-toggler'));
										e.preventDefault();
									}
								});
			}
			/*$(document).ready(function() {
				rowExpansion('inboxTable');
			});*/
		</script>
	</ui:define>
</ui:composition>